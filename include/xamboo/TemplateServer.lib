<?php

class TemplateServer extends Multiton
{
  private $template = null;

  public function __construct($id)
  {
    parent::__construct($id);

    // Separate page path from page id
    $uid = (strpos($id, '/') !== false)?substr($id, strrpos($id, '/')+1):$id;
    // $uid is <pageid>.<version>.<language>
    $path = strtok($id, '.');
    
    if (!is_file($this->base->PAGESDIR.$this->base->PAGESCONTAINER . '/' . $path . '/' . $uid . '.template'))
      return;
    $this->template = new TemplateSource(
      new FileSource($this->base->PAGESDIR, $this->base->PAGESCONTAINER . '/'. $path .'/', $uid . '.template'),
      new FastObjectSource(
        new FileSource($this->base->CACHE1DIR, 'afo/'. $this->base->PAGESCONTAINER . '/' . $path .'/', $uid . '.template.afo', true),
        $this->base->SHM?new SHMSource($this->base->PAGESCONTAINER . '/' . $path . '/' . $uid . '.template.afo', $this->base->SHM):null
        )
      );
  }
  
  public function read()
  {
    if ($this->template)
    {
      $t = $this->template->read();
      if ($t instanceof WATemplate)
        return $t->getClone();
    }
    return null;
  }

}



?>